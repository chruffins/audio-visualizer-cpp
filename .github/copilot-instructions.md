# Copilot Instructions

- **Purpose**: Desktop audio visualizer/player using Allegro 5 for rendering/audio, SQLite3 for the library, TagLib for metadata, and Discord SDK for presence. Entrypoint orchestrates playback + UI in [src/main.cpp](src/main.cpp).
- **Build/Run**: `cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug` then `cmake --build build`; run from `build` as `./audiovis`. Allegro/TagLib/SQLite3 must be installed; Discord shared lib is copied post-build (see [CMakeLists.txt](CMakeLists.txt)).
- **Global state**: App-wide resources live in the Meyers singleton [include/core/app_state.hpp](include/core/app_state.hpp) / [src/core/app_state.cpp](src/core/app_state.cpp). It owns Allegro display/queues/timers, `MusicEngine`, `MusicDatabase`, `Library`, `PlayQueue`, `FontManager`, and `DiscordIntegration`. Always go through `core::AppState::instance()` instead of constructing your own.
- **Initialization flow**: `AppState::init()` wires Allegro timers/event sources, initializes `MusicEngine`, opens the DB, loads the in-memory `Library` from DB, enqueues all songs into the shared `PlayQueue`, loads fonts, and optionally auto-plays the first song. `main()` then scans the music directory from config, updates the library, and enters the Allegro event loop.
- **Config**: [include/util/config.hpp](include/util/config.hpp) reads `config.ini` via Allegro config. Key getters: music directory, icon path, display size, Discord app id. Provide sane defaults if the file is missing (see [src/util/config.cpp](src/util/config.cpp)).
- **Audio engine**: [include/core/music_engine.hpp](include/core/music_engine.hpp) / [src/core/music_engine.cpp](src/core/music_engine.cpp) wrap Allegro audio (`voice` + `mixer` + `ALLEGRO_AUDIO_STREAM`). `playSound` destroys prior streams, loads a new stream, updates `ProgressBar` model, and triggers `onSongChanged` when it can map the filename to a `Song` in the library. Use `setPlayQueue` + `playNext()` to advance via the shared queue; `update()` should be called each graphics tick to refresh progress.
- **Library + DB**: `MusicDatabase` ([include/database/database.hpp](include/database/database.hpp), [src/database/database.cpp](src/database/database.cpp)) wraps SQLite with helpers for artists/albums/songs/genres/playlists and junction tables. Transactions are opt-in per caller. `Library` ([include/music/library.hpp](include/music/library.hpp), [src/music/library.cpp](src/music/library.cpp)) caches DB rows into maps and builds read-only views (`SongView`, `AlbumView`, etc.). Call `recreateViews()` after mutating the DB outside `loadFromDatabase`.
- **Scanning/import**: `LibraryScanner` ([include/database/library_scanner.hpp](include/database/library_scanner.hpp), [src/database/library_scanner.cpp](src/database/library_scanner.cpp)) walks directories with Allegro FS, filters audio via `al_identify_sample`, reads metadata via TagLib, groups tracks by album/album-artist, and inserts into the DB (optionally transactional). Provide a progress callback and a cancel flag when running long scans.
- **UI**: `NowPlayingView` ([include/graphics/views/now_playing.hpp](include/graphics/views/now_playing.hpp), [src/graphics/views/now_playing.cpp](src/graphics/views/now_playing.cpp)) draws text + progress bar using Allegro fonts via `FontManager`. Call setters when song/position changes; hook `MusicEngine::onSongChanged` to keep the UI in sync.
- **Event loop**: The main loop waits on Allegro events. `ALLEGRO_EVENT_TIMER` drives graphics redraw + music engine `update`, and a separate timer services Discord callbacks. Keybindings: `ESC` quits, `SPACE` toggles pause, `RIGHT` plays a random song via the library.
- **Discord**: `DiscordIntegration` is owned by `AppState` and is initialized lazily from the Discord callback timer. Only interact through `AppState::discord_integration` to avoid multiple init attempts.
- **Path conventions**: Media paths in the DB are stored as provided; `playSound` expects real filesystem paths (often absolute from scan). Config defaults point to `../assets` for the icon and `/home/chris/Music` for music.
- **When adding features**: Prefer updating the DB via `MusicDatabase` helpers, then refresh `Library::recreateViews()` if the in-memory cache must reflect changes. Keep Allegro resource lifecycles balanced (create in init, destroy in shutdown). Use the shared `PlayQueue` instead of ad-hoc playback order logic.

If anything here is unclear or missing, tell me which section to expand or correct and Iâ€™ll adjust quickly.
